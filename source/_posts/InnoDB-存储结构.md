---
title: InnoDB 存储结构
date: 2022-08-13 20:47:38
tags: MySQL
description: InnoDB 存储结构简介
---
# InnoDB 页

## 页的简介

页(Page) 是 InnoDB 的最小存取结构， InnoDB 中野的大小一般为 16KB。

InnoDB 是一个将表中数据持久化到磁盘中的存储引擎，当我们存储数据时，需要把数据从内存中刷到磁盘中，查询数据时又需要把数据从磁盘加载到内存中。我们知道读写磁盘的速度非常之慢，当我们想从表中获取某些记录时，如果一条一条把记录从磁盘上读取进内存，就需要多次读写，查询速度会非常之慢，但是如果我们一次性最少从磁盘中读取一页数据，也就是 16KB 数据到内存中，就避免了多次读写，提高查询效率。



# InnoDB 行格式

虽然读写数据的最小单位为页，但是一行记录在磁盘中的存储单位被称为 `行格式`。InnoDB 当前有 4 种不同类型的行格式，分别是 `Compact`、`Redundant`、`Dynamic`和`Compressed`行格式。


## COMPACT 行格式


![image_1c9g4t114n0j1gkro2r1h8h1d1t16.png](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/3/12/169710e8fafc21aa~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

### 变长字段真正长度列表

MySQL 的一些变长字段，例如 VARCHAR(M)，TEXT，BLOB  等类型都属于变长字段，变长字段的字节长度都存储在数据行记录的头部位置，并且是逆序存放，而且只存储值非 NULL 的字段。

另外由于变长字段的不确定性，我们也需要有一套规则决定变长字段长度的占用字节数。

先定义好几个参数的含义:

M: 变长类型可存储的最长字符数，W: 该字段字符集最大字节数，L：该字段实际存储字节数。

变长字段真正长度的占用字节数的规则：

* 如果 `MxW <= 255`(可变字段允许存储的最大字节数)，那么使用1个字节表示真正字符串所占用字节数。
* 如果 `M×W > 255`且`L <= 127`，则用1个字节表示真正字符串所占用字节数。
* 如果`M×W > 255`且`L > 127`，则用2个字节表示真正字符串所占用字节数。

总结一下就是，如果该可变字段允许存储的最大字节数（`M×W`）超过255字节并且真实存储的字节数（`L`）超过127字节，则使用2个字节，否则使用1个字节。

#### 那么问题来了，varchar(M) 变长字符中 M 的最大值是多少?

M 的定义：M 表示变长字段最长字符数。ps. 是字符不是字符串哦~

从上面得知,变长字段的真正长度可占用的最长字节数为2,那么我们可以认为变长字段的最大字节数应为 `2^16=65535`，那么 M 的最大值应该为 M = 65535/字符集最大字节数。

如果该字段字符集为 utf8mb4（最大字符大小为4个字节） 那么 M 的最大值为 `65535 / 4 = 16383.75`。

### NULL 值列表

如果把 NULL 值字段都保存在真实数据中，容易占用不必要的内存，因此 Compact 行格式会将值为 NULL 的列统一管理起来,存储到 NULL 值列表中（值不允许为 NULL  的列不在其中）。

每个字段是否为 NULL 值的结果在 NULL 值列表中逆序排放，并且每个字段仅占用二进制的一位。

* 二进制值为1时，代表该列值为 NULL
* 二进制值为0时,代表该列的值不为 NULL

并且由于程序最小存储单位为字节,则如果字段数低于8位,高位需要补零。如果一行数据仅有3个字段，那么 NULL 值列表为：

```ini
00000101
```

### 记录头信息

记录头信息由固定的 5 个字节组成，5 个字节也就是 40 个二进制位，不同的位代表不同的意思。

![image_1c9geiglj1ah31meo80ci8n1eli8f.png-29.5kB](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/3/12/169710e97718ef01~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

### 记录的真实数据

记录的真实数据除了用户定义好的列之外, MySQL 还会为每个记录默认添加一些隐藏列:

| 列名           | 是否必须 | 占用空间 | 描述                  |
| -------------- | -------- | -------- | --------------------- |
| row_id         | 否       | 6字节    | 行ID,唯一标识一条记录 |
| transaction_id | 是       | 6字节    | 事务ID                |
| roll_pointer   | 是       | 7字节    | 回滚指针              |

row_id 不是必须的,如果用户则缺少主键或者 unique 键，InnoDB 则会为表添加一个隐藏列 row_id 列作为主键。

用户定义的真实数据紧跟 row_id, transaction_id, roll_pointer 之后逆序排列，例如：row_id, transaction_id, roll_pointer，第 3 列的值，第 2 列的值，第 1 列的值。

其中每列值的数据占用长度又与使用的字符集以及字段类型，与定长字段或变长字段有关：

#### 字段是否变长

字段是否变长与字符集及字符类型有关。


#### 定长字段

只要字段属于定长字段并且字符集属于定长字符集，那么其长度已经固定，声明多少空间，就会占用多少真实数据长度。

#### 变长字段

如果字符集属于变长字符集 或 字段类型属于变长字段，那么其字段长度是有可能会变化，因此其字段值的长度会被加入变长字段真正长度列表。

# 溢出数据处理方式

Dynamic 行格式是 InnoDB 引擎的默认行格式。Dynamic 和 Compressed 行格式和 Compact 行格式很相似，它们与 Compact 的区别在于溢出页的存储方式。

对于 Compact 和 Redundant 来说，如果某一列中的数据非常多的话，在本记录的真实数据处只会存储该列的前`768`个字节的数据和一个指向其他页的地址，然后把剩下的数据存放到其他页中。

但是对于 Dynamic 和 Compressed 行格式来说，如果数据溢出，它们会将所有数据都存储到溢出页中，仅仅在真实数据处存储溢出页的地址。

# 参考
- [1] [MySQL 是怎样运行的：从根儿上理解 MySQL](https://s.juejin.cn/ds/jhuSJj7/)
